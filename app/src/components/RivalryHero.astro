---
import type { Entity } from '../lib/types';

interface Props {
  entity1: Entity;
  entity2: Entity;
  rivalryStart: string;
  rivalryEnd: string;
}

const { entity1, entity2, rivalryStart, rivalryEnd } = Astro.props;

// Helper to get initials for placeholder images
const getInitials = (name: string) => name.split(' ').map(n => n[0]).join('').slice(0, 2);

const entity1Image = entity1.images?.[0]?.url;
const entity2Image = entity2.images?.[0]?.url;
---

<!-- 1. The Fixed Header (Starts at 100vh, shrinks to 75px) -->
<header id="rivalry-header" class="hero-header">
  
  <!-- Period (Top) -->
  <div id="rivalry-period" class="absolute top-2 left-0 w-full text-center z-30">
    <p class="period-badge">
      {rivalryStart} â€” {rivalryEnd}
    </p>
  </div>

  <!-- Entity 1 (Top / Left) -->
  <div id="entity1-container" class="entity-pane top-0 bg-gray-100">
    <!-- Flex Layout: Text Left, Image Right -->
    <div id="entity1-content" class="entity-content">
        <!-- Text -->
        <h2 class="entity-name text-right" id="entity1-name">{entity1.label}</h2>
        <!-- Image -->
        <div class="entity-avatar bg-blue-500" id="entity1-img">
            {entity1Image ? (
              <img src={entity1Image} alt={entity1.label} class="w-full h-full object-cover" />
            ) : (
              getInitials(entity1.label)
            )}
        </div>
    </div>
  </div>

  <!-- Entity 2 (Bottom / Right) -->
  <div id="entity2-container" class="entity-pane bottom-0 bg-gray-50">
    <!-- Flex Layout: Image Left, Text Right -->
    <div id="entity2-content" class="entity-content">
        <!-- Image -->
        <div class="entity-avatar bg-red-500" id="entity2-img">
            {entity2Image ? (
              <img src={entity2Image} alt={entity2.label} class="w-full h-full object-cover" />
            ) : (
              getInitials(entity2.label)
            )}
        </div>
        <!-- Text -->
        <h2 class="entity-name text-left" id="entity2-name">{entity2.label}</h2>
    </div>
  </div>
  
  <!-- VS Badge (Center) -->
  <div id="vs-badge" class="vs-badge">
    <span class="text-2xl font-black text-gray-800">VS</span>
  </div>

</header>

<!-- 2. The Spacer -->
<div id="hero-spacer" class="h-screen w-full relative -z-10 pointer-events-none"></div>

<style>
  @reference "../styles/global.css";

  .hero-header {
    @apply fixed top-0 left-0 w-full h-screen bg-white z-50 overflow-hidden shadow-sm border-b border-gray-200;
  }

  .entity-pane {
    @apply absolute left-0 w-full h-1/2 flex items-center justify-center overflow-hidden;
  }

  .entity-content {
    @apply w-full h-full flex items-center justify-center gap-4 px-4;
  }

  .entity-name {
    @apply text-3xl font-bold text-gray-900 flex-1;
  }

  .entity-avatar {
    @apply w-48 h-48 shrink-0 flex items-center justify-center text-white text-4xl font-bold shadow-lg overflow-hidden;
  }

  .vs-badge {
    @apply absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30 bg-white rounded-full p-4 shadow-xl border-4 border-gray-100;
  }

  .period-badge {
    @apply text-lg font-medium text-gray-700 inline-block px-4 py-1;
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const initAnimations = () => {
    console.log('GSAP Animation Initializing (Spacer Shrink Mode)');
    
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: "body",
        start: "top top", 
        end: "100vh top",
        scrub: 0.5,
      }
    });

    // --- Header Shrink ---
    tl.to("#rivalry-header", { height: "75px", ease: "none" }, 0);
    
    // --- Spacer Shrink (The Fix) ---
    // Animate the spacer height from 100vh down to something closer to the final header height
    // plus some margin for the summary.
    // Note: Using "height" on a spacer works, but "marginTop" on the next element is sometimes smoother.
    // Let's stick to spacer height. 100vh -> 200px seems reasonable to pull content up.
    tl.to("#hero-spacer", { height: "200px", ease: "none" }, 0);

    // --- Entity 1 (Top -> Right Side) ---
    tl.to("#entity1-container", {
      height: "100%",
      width: "50%",
      left: "50%", 
      top: 0,
      backgroundColor: "transparent",
      ease: "none"
    }, 0);

    // Adjust content wrapper for header
    tl.to("#entity1-content", {
      paddingRight: "10px", 
      gap: "10px", 
      justifyContent: "flex-end", 
      ease: "none"
    }, 0);

    // Scale Image
    tl.to("#entity1-img", {
      width: "40px",
      height: "40px",
      fontSize: "14px",
      ease: "none"
    }, 0);

    // Scale Text
    tl.to("#entity1-name", {
      fontSize: "14px",
      flex: "0 1 auto", 
      whiteSpace: "nowrap",
      overflow: "hidden",
      textOverflow: "ellipsis",
      ease: "none"
    }, 0);


    // --- Entity 2 (Bottom -> Left Side) ---
    tl.to("#entity2-container", {
      height: "100%",
      width: "50%",
      left: 0,
      top: 0,
      bottom: "auto",
      backgroundColor: "transparent",
      ease: "none"
    }, 0);

    // Adjust content wrapper for header
    tl.to("#entity2-content", {
      paddingLeft: "10px", 
      gap: "10px",
      justifyContent: "flex-start", 
      ease: "none"
    }, 0);

    // Scale Image
    tl.to("#entity2-img", {
      width: "40px",
      height: "40px",
      fontSize: "14px",
      ease: "none"
    }, 0);

    // Scale Text
    tl.to("#entity2-name", {
      fontSize: "14px",
      flex: "0 1 auto",
      whiteSpace: "nowrap",
      overflow: "hidden",
      textOverflow: "ellipsis",
      ease: "none"
    }, 0);


    // --- Hide Elements ---
    tl.to("#vs-badge", { scale: 0, opacity: 0, display: "none", ease: "none" }, 0);
    tl.to("#rivalry-period", { opacity: 0, y: -50, display: "none", ease: "none" }, 0);
  };

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initAnimations();
  } else {
    document.addEventListener('DOMContentLoaded', initAnimations);
  }
</script>
